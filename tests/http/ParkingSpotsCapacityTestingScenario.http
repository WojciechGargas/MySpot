@url = http://localhost:5223
@parkingSpotId = 00000000-0000-0000-0000-000000000001
@date = 2026-02-15
@employee1 = John Doe
@employee2 = Jane Doe

# Scenario: parking spot capacity flow
# Vehicle reservation always uses Full capacity
# Capacity values:
# - 1 = OneQuarter
# - 2 = Half
# - 3 = ThreeQuarter
# - 4 = Full

### Step 1: List current parking spots and capture reservations
GET {{url}}/parking-spots

> {%
    const spots = Array.isArray(response.body) ? response.body : [];
    const reservations = spots.flatMap(s => Array.isArray(s.reservations) ? s.reservations : []);
    if (reservations.length > 0) {
        client.global.set("reservationId", reservations[0].id);
    } else {
        client.global.clear("reservationId");
    }
%}

### Step 2: Reserve Full capacity (should succeed)
POST {{url}}/parking-spots/{{parkingSpotId}}/reservations/vehicle
Content-Type: application/json

{
  "ParkingSpotId": "{{parkingSpotId}}",
  "ReservationId": "00000000-0000-0000-0000-000000000010",
  "Capacity": 4,
  "EmployeeName": "{{employee1}}",
  "LicensePlate": "XYZ123",
  "Date": "{{date}}"
}

### Step 3: Reserve another vehicle (should fail with capacity exceeded)
POST {{url}}/parking-spots/{{parkingSpotId}}/reservations/vehicle
Content-Type: application/json

{
  "ParkingSpotId": "{{parkingSpotId}}",
  "ReservationId": "00000000-0000-0000-0000-000000000011",
  "Capacity": 4,
  "EmployeeName": "{{employee2}}",
  "LicensePlate": "XYZ124",
  "Date": "{{date}}"
}

### Step 5: List parking spots again and capture the latest reservation id
GET {{url}}/parking-spots

> {%
    const spots = Array.isArray(response.body) ? response.body : [];
    const reservations = spots.flatMap(s => Array.isArray(s.reservations) ? s.reservations : []);
    const target = reservations.find(r => r.employeeName === "{{employee1}}" && r.date === "{{date}}");
    if (target) {
        client.global.set("reservationId", target.id);
    } else if (reservations.length > 0) {
        client.global.set("reservationId", reservations[0].id);
    } else {
        client.global.clear("reservationId");
    }
%}

### Step 6: Cleaning reservation for the same date (should replace vehicle reservations)
POST {{url}}/parking-spots/reservations/cleaning
Content-Type: application/json

{
  "Date": "{{date}}"
}

### Step 7: List parking spots again (verify only cleaning reservations)
GET {{url}}/parking-spots

> {%
    const spots = Array.isArray(response.body) ? response.body : [];
    const reservations = spots.flatMap(s => Array.isArray(s.reservations) ? s.reservations : []);
    // After cleaning, vehicle reservations are removed; pick any remaining reservation (cleaning).
    if (reservations.length > 0) {
        client.global.set("reservationId", reservations[0].id);
    } else {
        client.global.clear("reservationId");
    }
%}

### Step 8: Delete the latest reservation (manual cleanup)
DELETE {{url}}/parking-spots/reservations/{{reservationId}}
